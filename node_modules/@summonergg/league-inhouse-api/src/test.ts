import dotenv from "dotenv";
dotenv.config();
import Discord from "discord.js";
import { Guild, DiscordAPI, User, Game, Token } from "./";
import { Summoner } from "@summonergg/riot-api";
import log from "chalk-logging";

const client = new Discord.Client();

client.on("message", async (msg: DiscordMessage) => {
  var guild: Guild = await Guild.findOne({id: "605636172152176640"});
  var args: string[] = msg.content.split(" ");
  var command: string = args.shift().slice(1);
  
  msg.server = guild;
  msg.args = args;
  var api: DiscordAPI = new DiscordAPI({msg});
  if (command == "start") {
    try {
      var user: User = await api.findUser(["hasSummoner"]);
      if (!user) return;

      var game: Game = await api.findGame();
      if (!game) return;

      if (game.host !== user.discordId && !api.msg.auth("mod")) return;
      
      var isReady = await game.isReady();
      if (!isReady) return;

      await game.startLobby();
    } catch(err) { log.warning(err) }
  }
})

client.on("ready", () => {
  log.success("started")
})

client.login(process.env.DISCORD_TOKEN);
